<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensio App - Cloud</title>
    <!-- On importe Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">Ensio - Suivi de Chantier</h1>

        <!-- Formulaire -->
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium">Technicien</label>
                <input type="text" id="nom" class="w-full p-2 border rounded" placeholder="Ton nom">
            </div>
            <div>
                <label class="block text-sm font-medium">Type de Câble</label>
                <select id="cable" class="w-full p-2 border rounded">
                    <option value="Fibre Optique">Fibre Optique</option>
                    <option value="Cuivre">Cuivre</option>
                    <option value="Alimentation">Alimentation</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium">Longueur (mètres)</label>
                <input type="number" id="longueur" class="w-full p-2 border rounded" placeholder="0">
            </div>
            <button onclick="ajouterMesure()" id="btnAjouter" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
                Enregistrer sur le Cloud
            </button>
        </div>

        <hr class="my-6">

        <!-- Liste des mesures -->
        <h2 class="font-bold mb-2">Dernières données (Tous utilisateurs)</h2>
        <div id="liste" class="space-y-2">
            <p class="text-gray-500 text-center">Chargement des données...</p>
        </div>
    </div>

    <script>
        // CONFIGURATION SUPABASE (À REMPLIR)
        const SUPABASE_URL = sb_publishable_DVA3zG3jfVwR5CGexSu6kg_u8CJ9c9t;
        const SUPABASE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaXh6bHJtbXR6dHR0emdlamJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NzY1OTcsImV4cCI6MjA4NDA1MjU5N30.CAs3TW4OTVXRImSAr3nCg4xxXf6mD0dENS3DwJm-joo;
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Envoyer une donnée
        async function ajouterMesure() {
            const nom = document.getElementById('nom').value;
            const cable = document.getElementById('cable').value;
            const longueur = document.getElementById('longueur').value;
            const btn = document.getElementById('btnAjouter');

            if(!nom || !longueur) {
                alert("Remplis tous les champs !");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Envoi en cours...";

            const { error } = await supabase
                .from('metrages')
                .insert([{ 
                    nom_utilisateur: nom, 
                    type_cable: cable, 
                    longueur: parseFloat(longueur) 
                }]);

            if (error) {
                alert("Erreur : " + error.message);
            } else {
                document.getElementById('longueur').value = "";
                chargerDonnees(); // Rafraîchir la liste
            }
            
            btn.disabled = false;
            btn.innerText = "Enregistrer sur le Cloud";
        }

        // Charger les données depuis le cloud
        async function chargerDonnees() {
            const { data, error } = await supabase
                .from('metrages')
                .select('*')
                .order('date', { ascending: false })
                .limit(10);

            if (error) {
                console.error("Erreur chargement:", error);
                return;
            }

            const listeDiv = document.getElementById('liste');
            listeDiv.innerHTML = "";

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-3 bg-gray-50 border-l-4 border-blue-500 rounded text-sm";
                div.innerHTML = `
                    <div class="flex justify-between font-bold">
                        <span>${item.nom_utilisateur}</span>
                        <span class="text-blue-600">${item.longueur}m</span>
                    </div>
                    <div class="flex justify-between text-gray-500 text-xs">
                        <span>${item.type_cable}</span>
                        <span>${new Date(item.date).toLocaleDateString()}</span>
                    </div>
                `;
                listeDiv.appendChild(div);
            });
        }

        // Charger au démarrage
        chargerDonnees();
    </script>
</body>
</html>
